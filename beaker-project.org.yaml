- job:
    name: beaker-project.org
    description: |
        Builds all non-Sphinx web site content from 
        https://git.beaker-project.org/cgit/beaker-project.org/
        (some static files, release tarballs, yum repos, and Beaker-in-a-box) 
        and publishes it to https://beaker-project.org/.
    auth-token: !include beaker-project.org-auth-token.txt
    scm:
        - git:
            url: git://git.beaker-project.org/beaker-project.org
            branches:
                - origin/master
            basedir: beaker-project.org
            clean: false # we don't want to fetch tarballs and RPMs every time!
            wipe-workspace: false
            skip-tag: true
        - git:
            url: git://git.beaker-project.org/beaker
            branches:
                - origin/master
            basedir: beaker
            clean: true
            wipe-workspace: false
            skip-tag: true
            reference-repo: /var/lib/jenkins/jobs/beaker-rpms/workspace
    triggers:
        - pollscm: "H/5 * * * *"
    wrappers:
        - exclusion:
            resources:
                - htdocs
    builders:
        - shell: |
            cd beaker-project.org/
            make clean
            make

        - critical-block-start
        - shell: |
            cd beaker-project.org/
            rsync -v -e 'ssh -i /var/lib/jenkins/.ssh/id_rsa' -r -l --checksum --delete-after --exclude=.git\* --exclude=dev --exclude=docs --exclude=docs-\* ./ jenkins@beaker-project.org:/srv/www/beaker-project.org/htdocs/
            ssh -i /var/lib/jenkins/.ssh/id_rsa jenkins@beaker-project.org /srv/www/beaker-project.org/published.sh "Automatic\ commit\ by\ Jenkins\ job\ ${JOB_NAME}\ \#${BUILD_NUMBER}"
        - critical-block-end
