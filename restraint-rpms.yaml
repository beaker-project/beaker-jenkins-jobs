- job-template:
    name: restraint-rpms-{distro}
    description: |
        Builds RPMs for {distro} in Beaker's Koji based on every restraint commit.
    properties:
        - priority-sorter:
            priority: 120
    node: fedora
    scm:
        - git:
            url: git://git.beaker-project.org/restraint
            branches:
                - origin/master
            clean:
                before: true
            wipe-workspace: false
            skip-tag: true
            reference-repo: /var/lib/jenkins/gitreference/restraint
    triggers:
        - pollscm:
            cron: "H/5 * * * *"
    builders:
        - restraint-fetch-tarballs
        - shell: |
            rm -f *.src.rpm
            commits_since_tag=$(git rev-list $(git describe --abbrev=0).. | wc -l)
            if [ "$commits_since_tag" -eq 0 ] ; then
                tito build --dist {dist} --srpm --output .
                koji -p beakerkoji build --wait {kojitag} ./restraint*{dist}.src.rpm
            else
                tito build --dist {dist} --srpm --output . --test
                koji -p beakerkoji build --wait {kojitag}-testing ./restraint*{dist}.src.rpm
            fi
    notifications:
        - notify-matrix-bot

- project:
    name: restraint-rpms
    distro: !include: restraint-rpms-distroconfig.yaml.inc
    jobs:
        - "restraint-rpms-{distro}"
