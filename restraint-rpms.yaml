- job-template:
    name: restraint-rpms-{distro}
    description: |
        Builds RPMs for {distro} in Beaker's Koji based on every restraint commit.
    scm:
        - git:
            url: git://git.beaker-project.org/restraint
            branches:
                - origin/master
            clean: true
            wipe-workspace: false
            skip-tag: true
    triggers:
        - pollscm: "H/5 * * * *"
    publishers:
        - report-failures
    builders:
        - shell: |
            # Hack to pull tarballs from dist-git, instead of from the internet
            cd third-party
            curl -fsS 'http://pkgs.devel.redhat.com/cgit/rpms/restraint/plain/sources?h=eng-rhel-6' | while read hash filename ; do curl -fsSLO http://pkgs.devel.redhat.com/repo/pkgs/restraint/$filename/$hash/$filename ; done
        - shell: |
            rm -f *.src.rpm
            commits_since_tag=$(git rev-list $(git describe --abbrev=0).. | wc -l)
            if [ "$commits_since_tag" -eq 0 ] ; then
                tito build --dist {dist} --srpm --output .
                koji -p beakerkoji build --wait {kojitag} ./restraint*{dist}.src.rpm
            else
                tito build --dist {dist} --srpm --output . --test
                koji -p beakerkoji build --wait {kojitag}-testing ./restraint*{dist}.src.rpm
            fi

- project:
    name: restraint-rpms
    distro:
        - Fedorarawhide:
            dist: .fc25
            kojitag: beaker-harness-fedora-rawhide
        - Fedora24:
            dist: .fc24
            kojitag: beaker-harness-fedora-24
        - Fedora23:
            dist: .fc23
            kojitag: beaker-harness-fedora-23
        - Fedora22:
            dist: .fc22
            kojitag: beaker-harness-fedora-22
        - RedHatEnterpriseLinux7:
            dist: .el7_2
            kojitag: beaker-harness-rhel-7
        - RedHatEnterpriseLinux6:
            dist: .el6
            kojitag: beaker-harness-rhel-6
        - RedHatEnterpriseLinux5:
            dist: .el5_9
            kojitag: beaker-harness-rhel-5
        - RedHatEnterpriseLinux4:
            dist: .el4_8
            kojitag: beaker-harness-rhel-4
    jobs:
        - "restraint-rpms-{distro}"
