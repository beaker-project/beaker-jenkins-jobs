- job-template:
    name: beaker-in-a-box-tests-{distro}
    description: |
        Runs Beaker-in-a-box ansible playbook inside Beaker, for patches merged to master.
    logrotate:
        daysToKeep: 30
    concurrent: true
    node: fedora
    scm:
        - git:
            browser: cgit
            browser-url: https://git.beaker-project.org/cgit/beaker-in-a-box/
            reference-repo: /var/lib/jenkins/gitreference/beaker-in-a-box
            url: ssh://jenkins@gerrit.beaker-project.org:29418/beaker-in-a-box
            credentials-id: "fac135e6-5a13-4cd0-8dd5-737da825099b"
            choosing-strategy: gerrit
            name: gerrit
            refspec: +refs/heads/*:refs/remotes/gerrit/* $GERRIT_REFSPEC
            # 'branches' key is meaningless with Gerrit Trigger, but the
            # default value '**' causes a NullPointerException:
            # https://issues.jenkins-ci.org/browse/JENKINS-27559
            branches:
                - master
            merge:
                remote: gerrit
                branch: $GERRIT_BRANCH
            changelog-against:
                remote: gerrit
                branch: $GERRIT_BRANCH
            clean:
                before: true
            wipe-workspace: false
            skip-tag: true
            use-author: true
    triggers:
        - gerrit:
            server-name: gerrit.beaker-project.org
            projects:
                - project-compare-type: PLAIN
                  project-pattern: beaker-in-a-box
                  branches:
                    - branch-compare-type: ANT
                      branch-pattern: "**"
            trigger-on:
                - comment-added-event:
                    approval-category: Ready-for-Checks
                    approval-value: 1
            custom-url: "https://beaker-project.org/jenkins-results/$JOB_NAME/$BUILD_NUMBER/"

    builders:
        - shell: |
            cat >client.conf <<EOF
            HUB_URL="https://beaker-devel.app.eng.bos.redhat.com"
            AUTH_METHOD="krbv"
            EOF
            export BEAKER_CLIENT_CONF=client.conf
            k5start -U -f $JENKINS_KEYTAB

            job_submit_output=$(bkr job-submit - <<EOF
            <job group="beakerdevs" retention_tag="scratch">
                <whiteboard>$JOB_NAME #$BUILD_NUMBER</whiteboard>
                <recipeSet priority="Medium">
                    <recipe whiteboard="Beaker In A Box Playbook Test">
                        <repos />
                        <packages/>
                        <distroRequires>
                            <distro_arch op="=" value="x86_64" />
                            <distro_variant op="=" value="Workstation" />
                            <family op="=" value="{distro}"/>
                        </distroRequires>
                        <hostRequires>
                            <system_type value="Machine"/>
                            <key_value key="HVM" op="=" value="1" />
                        </hostRequires>
                        <partitions/>
                        <task name="/distribution/install" role="STANDALONE" />
                        <task name="/distribution/beaker/beaker-in-a-box" role="STANDALONE" />
                    </recipe>
                </recipeSet>
            </job>
            EOF
            )
            jobid=$(echo $job_submit_output | awk -F\' '{{print $2}}')

            bkr job-watch $jobid || :

            mkdir -p beaker/$jobid
            bkr job-results --prettyxml $jobid >beaker/$jobid/results.xml

            jobresult=$(xmlstarlet sel -t -v 'concat(/job/@status, "/", /job/@result)' <beaker/$jobid/results.xml)
            if [[ "$jobresult" != "Completed/Pass" ]] ; then
                exit 1
            fi
    wrappers:
        - credentials-binding:
            - file:
                credential-id: "1fc5282d-0e61-4736-ace4-9ff23b065636"
                variable: JENKINS_KEYTAB

- project:
    name: beaker-in-a-box-tests
    distro:
        - Fedora27
    jobs:
        - beaker-in-a-box-tests-{distro}
