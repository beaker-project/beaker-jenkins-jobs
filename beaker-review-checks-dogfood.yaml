- job-template:
    name: beaker-review-checks-dogfood-{distro}
    description: |
        Runs Beaker's test suite inside Beaker, for patches posted to Gerrit.
    logrotate:
        daysToKeep: 30
    concurrent: true
    node: fedora
    scm: !include: beaker-review-checks-scmconfig.yaml.inc
    triggers:
        - beaker-review-checks-gerrit-trigger:
            file_paths_pattern: "^(Server/|Client/|LabController/|Common/|IntegrationTests/|Makefile|beaker\\.spec).*"
            dependency_jobs: "beaker-review-checks-rpms-{distro},beaker-review-checks-pylint"
            ignorefail: "{ignorefail}"
    properties:
        - inject:
            groovy-content: |
                import com.sonyericsson.hudson.plugins.gerrit.trigger.hudsontrigger.GerritCause
                def gerritCause = currentBuild.getCause(GerritCause)
                if (gerritCause != null) {{
                    def rpmJobTriggered = gerritCause.context.others.find {{ it.projectId == 'beaker-review-checks-rpms-{distro}' }}
                    return [RPM_BUILD_NUMBER: rpmJobTriggered.buildNumber]
                }}
        - throttle:
            option: project
            max-total: 4
    builders:
        - shell: |
            cat >client.conf <<EOF
            HUB_URL="https://beaker-devel.app.eng.bos.redhat.com"
            AUTH_METHOD="krbv"
            EOF
            export BEAKER_CLIENT_CONF=client.conf
            k5start -U -f $JENKINS_KEYTAB

            job_submit_output=$(bkr job-submit - <<EOF
            <job group="beakerdevs" retention_tag="scratch">
                <whiteboard>
                    beaker dogfood {distro} for Gerrit $GERRIT_CHANGE_NUMBER/$GERRIT_PATCHSET_NUMBER: $(xmlstarlet esc "$GERRIT_CHANGE_SUBJECT")
                </whiteboard>
                <recipeSet priority="{jobprio}">
                    <recipe ks_meta="harness=restraint-rhts method=http selinux=--disabled !install_task_requires" whiteboard="Nose Tests">
                        <repos>
                            {extrarepos}
                            <repo name="beaker-project-server" url="https://beaker-project.org/yum/server-testing/{distro}/" />
                            <repo name="beaker-gitbuild" url="https://beaker-project.org/jenkins-results/beaker-review-checks-rpms-{distro}/$RPM_BUILD_NUMBER/koji-result/" />
                            <!-- harness repo is needed so that rhts-test-env and rhts-python versions match -->
                            <repo name="beaker-project-harness" url="https://beaker-project.org/yum/harness-testing/{distro}/" />
                            <!-- for beaker-server-redhat -->
                            <repo name="beaker-server-redhat" url="http://file.bos.redhat.com/~dcallagh/beaker-server-redhat/{distro}/" />
                        </repos>
                        <packages>
                            <package name="-prelink" />
                            <!--
                            OpenStack includes mariadb-galera-server which provides mysql-server,
                            thereby confusing Anaconda since the /distribution/beaker/setup task
                            requires both mariadb-server (for RHEL7) and mysql-server (for RHEL6).
                            We exclude mariadb-galera-server so that Anaconda can figure out
                            what we want (which is the normal mariadb-server).
                            -->
                            <package name="-mariadb-galera-server" />
                            <!-- Workaround for https://bugzilla.redhat.com/show_bug.cgi?id=1614628 -->
                            <package name="elfutils-libs" />
                            <package name="python-keystoneclient" />
                            <package name="python-novaclient" />
                            <package name="python-glanceclient" />
                            <package name="python-neutronclient" />
                            <package name="beaker-server-redhat" />
                        </packages>
                        <distroRequires>
                            <distro_family op="=" value="{distro}"/>
                            <distro_arch op="=" value="x86_64" />
                            <distro_variant op="=" value="{variant}" />
                            <distro_tag op="=" value="{distrotag}" />
                        </distroRequires>
                        <hostRequires>
                            <system_type value="Machine"/>
                            <memory op="&gt;=" value="4096"/>
                            <not><pool value="too-slow-for-beaker-dogfood"/></not>
                        </hostRequires>
                        <partitions/>
                        <task name="/distribution/check-install" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                            </params>
                        </task>
                        <task name="/distribution/beaker/setup" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                                <param name="EXPECT_BEAKER_GIT_BUILD" value="1"/>
                                <param name="MYSQL_EXTRA_CONFIG" value="innodb-flush-log-at-trx-commit = 2"/>
                                <param name="OPENSTACK_IDENTITY_API_URL" value="https://ci-rhos.centralci.eng.rdu2.redhat.com:13000/v3"/>
                                <param name="OPENSTACK_BEAKER_USERNAME" value="$OPENSTACK_BEAKER_USERNAME"/>
                                <param name="OPENSTACK_BEAKER_PASSWORD" value="$OPENSTACK_BEAKER_PASSWORD"/>
                            </params>
                        </task>
                        <task name="/distribution/beaker/dogfood" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                                <param name="BEAKER_SKIP_INIT_DB" value=""/>
                                <param name="EXPECT_BEAKER_GIT_BUILD" value="1"/>
                                <param name="PACKAGES_TO_TEST" value="bkr.inttest bkr.redhat"/>
                                <param name="OPENSTACK_DUMMY_USERNAME" value="$OPENSTACK_DUMMY_USERNAME"/>
                                <param name="OPENSTACK_DUMMY_PASSWORD" value="$OPENSTACK_DUMMY_PASSWORD"/>
                                <param name="OPENSTACK_DUMMY_PROJECT_NAME" value="beaker-jenkins"/>
                            </params>
                        </task>
                    </recipe>
                </recipeSet>
            </job>
            EOF
            )
            jobid=$(echo $job_submit_output | awk -F\' '{{print $2}}')

            bkr job-watch $jobid || :

            mkdir -p beaker/$jobid
            bkr job-results --prettyxml $jobid | \
                sed -e 's@[-a-zA-Z0-9.]*\.redhat\.com@CENSORED.redhat.com@g' \
                >beaker/$jobid/results.xml
            bkr job-results --format=junit-xml $jobid >beaker/$jobid/junit.xml
            bkr job-logs $jobid | grep -v debug/ | \
            while read url ; do
                # turn a URL like http://.../1234/logs/TESTOUT.log into 1234-TESTOUT.log
                filename="$(echo "$url" | sed -r -e 's@^.*/([0-9]+)/logs/([^/]*$)@\1-\2@')"
                curl -L -f -s -S -o "beaker/$jobid/$filename" "$url"
            done

            jobresult=$(xmlstarlet sel -t -v 'concat(/job/@status, "/", /job/@result)' <beaker/$jobid/results.xml)
            if [[ "$jobresult" != "Completed/Pass" ]] ; then
                exit 1
            fi
    publishers:
        - archive:
            artifacts: beaker/**
        - junit:
            results: beaker/*/junit.xml
    wrappers:
        - credentials-binding:
            - username-password-separated:
                credential-id: "2d19002d-5d84-4448-858e-bf76a5175eac"
                username: OPENSTACK_BEAKER_USERNAME
                password: OPENSTACK_BEAKER_PASSWORD
            - username-password-separated:
                credential-id: "df01f050-b351-4738-8c1b-39069a85dcc5"
                username: OPENSTACK_DUMMY_USERNAME
                password: OPENSTACK_DUMMY_PASSWORD
            - file:
                credential-id: "1fc5282d-0e61-4736-ace4-9ff23b065636"
                variable: JENKINS_KEYTAB
        - publish-over-ssh-post-build:
            site: "beaker-project.org jenkins-results"
            source: "beaker/**"
            target: "$JOB_NAME/$BUILD_NUMBER"

- project:
    name: beaker-review-checks-dogfood
    distro: !include: beaker-dogfood-distroconfig.yaml.inc
    jobs:
        - beaker-review-checks-dogfood-{distro}
