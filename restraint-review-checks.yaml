- job:
    name: restraint-review-checks
    description: |
        Performs pre-merge checks for Restraint patches under review.
    logrotate:
        numToKeep: 30
    # no concurrent builds because the tests start daemons listening on fixed ports
    concurrent: false
    scm:
        - git:
            url: ssh://jenkins@gerrit.beaker-project.org:29418/restraint
            credentials-id: "fac135e6-5a13-4cd0-8dd5-737da825099b"
            choosing-strategy: gerrit
            name: gerrit
            refspec: "+refs/heads/*:refs/remotes/gerrit/* $GERRIT_REFSPEC"
            # 'branches' key is meaningless with Gerrit Trigger, but the
            # default value '**' causes a NullPointerException:
            # https://issues.jenkins-ci.org/browse/JENKINS-27559
            branches:
                - master
            merge:
                remote: gerrit
                branch: $GERRIT_BRANCH
            changelog-against:
                remote: gerrit
                branch: $GERRIT_BRANCH
            clean:
                after: true
            wipe-workspace: false
            skip-tag: true
    triggers:
        - gerrit:
            server-name: gerrit.beaker-project.org
            projects:
                - project-compare-type: PLAIN
                  project-pattern: restraint
                  branches:
                    - branch-compare-type: ANT
                      branch-pattern: "**"
            trigger-on:
                - comment-added-event:
                    approval-category: Ready-for-Checks
                    approval-value: 1
            custom-url: "https://beaker-project.org/jenkins-results/${JOB_NAME}/${BUILD_NUMBER}/"
    builders:
        - shell: |
            make
            make check | tee check.log
            make -C src valgrind 2>&1 | tee valgrind.log
        - shell: |
            rm -f *.src.rpm
            tito build --test --srpm --output .
            taskids=()
            for tag in beaker-harness-fedora-{22,21,20} beaker-harness-rhel-{7,6,5,4} ; do
                output=$(koji -p beakerkoji build --nowait --scratch --arch-override=x86_64 $tag *.src.rpm)
                if [[ $? -ne 0 ]] ; then
                    echo "$output" >&2
                    exit 1
                fi
                taskids+=($(grep -P -o '(?<=Created task: )\d+' <<<"$output"))
            done
            set +e
            koji -p beakerkoji watch-task ${taskids[@]}
            rc=$?
            mkdir -p koji-logs
            koji -p beakerkoji download-logs -r -d koji-logs ${taskids[@]}
            exit $rc
    wrappers:
        - publish-over-ssh-post-build:
            site: "beaker-project.org jenkins-results"
            source: "check.log valgrind.log koji-logs/**"
            target: "${JOB_NAME}/${BUILD_NUMBER}"
