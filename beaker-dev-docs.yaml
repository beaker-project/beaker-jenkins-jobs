- job:
    name: beaker-dev-docs
    description: "Beaker dev docs"
    scm:
        - git:
            url: git://git.beaker-project.org/beaker-project.org
            branches:
                - origin/master
            basedir: beaker-project.org
            clean: true
            wipe-workspace: false
            skip-tag: true
            included-regions:
                - "sphinx-theme/.*"
            sparse-checkout:
                - "sphinx-theme"
            reference-repo: /var/lib/jenkins/jobs/beaker-project.org/workspace/beaker-project.org
        - git:
            url: git://git.beaker-project.org/beaker-dev-docs
            branches:
                - origin/master
            basedir: beaker-dev-docs
            clean: true
            wipe-workspace: false
            skip-tag: true
    triggers:
        - pollscm: "H/5 * * * *"
    builders:
        - shell: |
            cd beaker-dev-docs/

            # In Sphinx 1.3 this can become -D html_theme_path=...
            echo "html_theme_path = ['../beaker-project.org/sphinx-theme']" >>conf.py

            sphinx-build -W -b html -D html_theme=beaker . _build/html
            rm -r _build/html/.doctrees

        - shell: |
            cd beaker-dev-docs/
            rsync -v -e 'ssh -i /var/lib/jenkins/.ssh/id_rsa' --rsync-path 'flock /srv/www/beaker-project.org/htdocs/ rsync' -a --delete-after _build/html/ jenkins@beaker-project.org:/srv/www/beaker-project.org/htdocs/dev/
            ssh -i /var/lib/jenkins/.ssh/id_rsa jenkins@beaker-project.org /srv/www/beaker-project.org/published.sh "Automatic\ commit\ by\ Jenkins\ job\ ${JOB_NAME}\ \#${BUILD_NUMBER}"
    publishers:
        - archive:
            artifacts: beaker-dev-docs/_build/html/**
