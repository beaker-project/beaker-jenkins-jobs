- job:
    name: beaker-review-checks
    description: |
        Checks patches posted to Gerrit for review.
        Patches are only checked after receiving a Ready-for-Checks+1 score 
        (granted automatically to Beaker core developers' patches).
    logrotate:
        daysToKeep: 30
    concurrent: true
    scm:
        - git:
            browser: cgit
            browser-url: https://git.beaker-project.org/cgit/beaker/
            reference-repo: /var/lib/jenkins/jobs/beaker-rpms/workspace
            url: ssh://jenkins@gerrit.beaker-project.org:29418/beaker
            credentials-id: "fac135e6-5a13-4cd0-8dd5-737da825099b"
            choosing-strategy: gerrit
            name: gerrit
            refspec: +refs/heads/*:refs/remotes/gerrit/* $GERRIT_REFSPEC
            # 'branches' key is meaningless with Gerrit Trigger, but the
            # default value '**' causes a NullPointerException:
            # https://issues.jenkins-ci.org/browse/JENKINS-27559
            branches:
                - master
            submodule:
                recursive: true
            merge:
                remote: gerrit
                branch: $GERRIT_BRANCH
            changelog-against:
                remote: gerrit
                branch: $GERRIT_BRANCH
            clean:
                before: true
            wipe-workspace: false
            skip-tag: true
            use-author: true
    triggers:
        - gerrit:
            server-name: gerrit.beaker-project.org
            projects:
                - project-compare-type: PLAIN
                  project-pattern: beaker
                  branches:
                    - branch-compare-type: ANT
                      branch-pattern: "**"
            trigger-on:
                - comment-added-event:
                    approval-category: Ready-for-Checks
                    approval-value: 1
            custom-url: "https://beaker-project.org/jenkins-results/${JOB_NAME}/${BUILD_NUMBER}/"
    builders:
        - shell: |
            if [[ "$GIT_BRANCH" == "origin/develop" ]] ; then
                Misc/rpmbuild.sh --next-major -bs
                Misc/rpmbuild.sh --next-major -bb
            else
                Misc/rpmbuild.sh -bs
                Misc/rpmbuild.sh -bb
            fi

        - shell: |
            if [ -f Misc/rpmlint-config.py ] ; then # since Beaker 22
                rpmlint -f Misc/rpmlint-config.py -o "NetworkEnabled False" rpmbuild-output/*.rpm rpmbuild-output/*/*.rpm
            fi

        - shell: |
            make -C documentation html SPHINXOPTS="-W"

        - shell: |
            Misc/run-pylint.sh --report=no --disable=W bkr.server bkr.labcontroller bkr.client bkr.common

        - shell: |
            job_submit_output=$(bkr job-submit - <<EOF
            <job group="beakerdevs" retention_tag="scratch">
                <whiteboard>
                    beaker dogfood for Gerrit change ${GERRIT_CHANGE_NUMBER} patch ${GERRIT_PATCHSET_NUMBER}: $(xmlstarlet esc "${GERRIT_CHANGE_SUBJECT}")
                </whiteboard>
                <recipeSet priority="Low">
                    <recipe ks_meta="method=http selinux=disabled" whiteboard="Nose Tests">
                        <repos>
                            <repo name="beaker-project-server" url="https://beaker-project.org/yum/server-testing/RedHatEnterpriseLinux6/" />
                            <!-- harness repo is needed so that rhts-test-env and rhts-python versions match -->
                            <repo name="beaker-project-harness" url="https://beaker-project.org/yum/harness-testing/RedHatEnterpriseLinux6/" />
                            <!-- for beaker-server-redhat -->
                            <repo name="beaker-server-redhat" url="http://file.bos.redhat.com/~dcallagh/beaker-server-redhat/" />
                        </repos>
                        <packages>
                            <package name="-prelink" />
                            <package name="beaker-server-redhat" />
                        </packages>
                        <distroRequires>
                            <distro_family op="=" value="RedHatEnterpriseLinux6"/>
                            <distro_arch op="=" value="x86_64" />
                            <distro_variant op="=" value="Server" />
                            <distro_tag op="=" value="RELEASED" />
                        </distroRequires>
                        <hostRequires>
                            <system_type value="Machine"/>
                            <memory op="&gt;=" value="900" />
                        </hostRequires>
                        <partitions/>
                        <task name="/distribution/install" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                            </params>
                        </task>
                        <task name="/distribution/beaker/setup" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                                <param name="SOURCE" value="_git"/>
                                <param name="BEAKER_GIT_REF" value="${GERRIT_BRANCH}"/>
                                <param name="BEAKER_GIT_REMOTE" value="http://gerrit.beaker-project.org/p/beaker"/>
                                <param name="BEAKER_GIT_REMOTE_REF" value="${GERRIT_REFSPEC}"/>
                                <param name="BEAKER_GIT_REMOTE_MERGE" value="merge"/>
                            </params>
                        </task>
                        <task name="/distribution/beaker/dogfood" role="STANDALONE">
                            <params>
                                <param name="RHTS_OPTION_COMPATIBLE" value=""/>
                                <param name="RHTS_OPTION_COMPAT_SERVICE" value=""/>
                                <param name="BEAKER_SKIP_INIT_DB" value=""/>
                                <param name="SOURCE" value="_git"/>
                                <param name="PACKAGES_TO_TEST" value="bkr.inttest bkr.redhat"/>
                            </params>
                        </task>
                    </recipe>
                </recipeSet>
            </job>
            EOF
            )
            jobid=$(echo $job_submit_output | awk -F\' '{print $2}')

            bkr job-watch $jobid || :

            mkdir -p beaker/$jobid
            bkr job-results --prettyxml $jobid | \
                sed -e 's@[-a-zA-Z0-9.]*\.redhat\.com@CENSORED.redhat.com@g' \
                >beaker/$jobid/results.xml
            bkr job-results --format=junit-xml $jobid >beaker/$jobid/junit.xml
            bkr job-logs $jobid | grep -v debug | \
            while read url ; do
                # turn a URL like http://.../1234/TESTOUT.log into 1234-TESTOUT.log
                filename="$(echo "$url" | sed -r -e 's@^.*/([0-9]+)/([^/]*$)@\1-\2@')"
                curl -f -s -S -o "beaker/$jobid/$filename" "$url"
            done

            jobresult=$(xmlstarlet sel -t -v 'concat(/job/@status, "/", /job/@result)' <beaker/$jobid/results.xml)
            if [[ "$jobresult" != "Completed/Pass" ]] ; then
                exit 1
            fi

    publishers:
        - junit:
            results: beaker/*/junit.xml

    wrappers:
        - publish-over-ssh-post-build:
            site: "beaker-project.org jenkins-results"
            source: "beaker/**"
            target: "${JOB_NAME}/${BUILD_NUMBER}"
